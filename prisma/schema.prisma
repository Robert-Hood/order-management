generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          String    @id @default(cuid())
  phone       String    @unique        // unique identifier
  name        String
  orderCount  Int       @default(0)    // denormalized for quick access
  totalSpent  Float     @default(0)    // denormalized for quick access
  lastOrderAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  orders      Order[]
}

model Order {
  id              String      @id @default(cuid())
  customerName    String
  customerPhone   String

  // link to customer (optional - only if phone was provided)
  customerId      String?
  customer        Customer?   @relation(fields: [customerId], references: [id])

  // totals
  amount          Float       // final total AFTER discount
  subtotal        Float       @default(0)
  discountPercent Float       @default(0)
  discountAmount  Float       @default(0)
  discountNote    String?

  createdAt       DateTime    @default(now())
  deletedAt       DateTime?   // soft delete - null means active
  items           OrderItem[]
}

model Product {
  id           String   @id @default(cuid())
  name         String
  price        Float
  cost         Float
  isActive     Boolean  @default(true)
  hasModifiers Boolean  @default(false)

  createdAt    DateTime @default(now())
  orders       OrderItem[]
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Float
  lineTotal Float
  createdAt DateTime @default(now())

  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  modifiers OrderItemModifier[]
}

model Modifier {
  id        String   @id @default(cuid())
  name      String
  price     Float
  cost      Float
  type      String   @default("topping")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  orderItemModifiers OrderItemModifier[]
}

model OrderItemModifier {
  id           String   @id @default(cuid())
  orderItemId  String
  modifierId   String

  nameAtTime   String
  priceAtTime  Float
  costAtTime   Float

  createdAt    DateTime @default(now())

  orderItem    OrderItem @relation(fields: [orderItemId], references: [id])
  modifier     Modifier  @relation(fields: [modifierId], references: [id])
}
